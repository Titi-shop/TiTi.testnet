"use client";

import { useEffect, useState } from "react";
import { useCart } from "../context/CartContext";
import { useRouter } from "next/navigation";

export default function CheckoutPage() {
  const { cart, clearCart, total } = useCart();
  const [wallet, setWallet] = useState<number>(0);
  const [loading, setLoading] = useState(false);
  const [user, setUser] = useState("guest");
  const router = useRouter();

  // ü™ô L·∫•y v√≠ Pi v√† user khi m·ªü trang
  useEffect(() => {
    const w = Number(localStorage.getItem("pi_wallet") ?? "1000");
    setWallet(w);
    if (!localStorage.getItem("pi_wallet")) {
      localStorage.setItem("pi_wallet", String(w));
    }

    const u = localStorage.getItem("pi_user") ?? "guest";
    setUser(u);
  }, []);

  // üí≥ X·ª≠ l√Ω thanh to√°n
  const handlePay = async () => {
    if (cart.length === 0) return alert("üõí Gi·ªè h√†ng tr·ªëng.");
    if (wallet < total) return alert("üìõ V√≠ Pi kh√¥ng ƒë·ªß. Vui l√≤ng n·∫°p th√™m.");

    setLoading(true);
    try {
      // ‚úÖ Tr·ª´ v√≠
      const newWallet = wallet - total;
      localStorage.setItem("pi_wallet", String(newWallet));
      setWallet(newWallet);

      // ‚úÖ T·∫°o ƒë∆°n h√†ng c√≥ tr·∫°ng th√°i ch·ªù x√°c nh·∫≠n
      const order = {
        id: Date.now(),
        items: cart,
        total,
        createdAt: new Date().toISOString(),
        buyer: user,
        status: "Ch·ªù x√°c nh·∫≠n",
      };

      // ‚úÖ G·ª≠i l√™n API (v√† fallback localStorage n·∫øu API fail)
      const res = await fetch("/api/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(order),
      });

      if (!res.ok) {
        console.warn("‚ö†Ô∏è API kh√¥ng ph·∫£n h·ªìi, l∆∞u t·∫°m localStorage");
        const existing = JSON.parse(localStorage.getItem("orders") ?? "[]");
        existing.push(order);
        localStorage.setItem("orders", JSON.stringify(existing));
      }

      // ‚úÖ D·ªçn gi·ªè v√† ƒëi·ªÅu h∆∞·ªõng
      clearCart();
      alert(`‚úÖ Thanh to√°n th√†nh c√¥ng!\nƒê√£ tr·ª´ ${total} Pi kh·ªèi v√≠.`);
      router.push("/customer/pending");
    } catch (err) {
      console.error("‚ùå L·ªói khi thanh to√°n:", err);
      alert("‚ùå Giao d·ªãch th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
      setWallet(Number(localStorage.getItem("pi_wallet") ?? "0"));
    } finally {
      setLoading(false);
    }
  };

  // üßæ Giao di·ªán
  return (
    <main className="max-w-3xl mx-auto p-6 bg-gray-50 min-h-screen">
      <h1 className="text-2xl font-bold mb-4 text-center text-orange-600">
        üí≥ Thanh to√°n
      </h1>

      <div className="bg-white p-4 rounded shadow mb-4">
        <p>
          Ng∆∞·ªùi mua: <b>{user}</b>
        </p>
        <p>
          V√≠ Pi hi·ªán t·∫°i: <b className="text-yellow-600">{wallet} Pi</b>
        </p>
        <p>
          T·ªïng ƒë∆°n h√†ng: <b className="text-yellow-600">{total} Pi</b>
        </p>
      </div>

      <button
        onClick={handlePay}
        disabled={loading}
        className={`w-full py-3 rounded text-white font-semibold ${
          loading ? "bg-gray-400" : "bg-green-500 hover:bg-green-600"
        }`}
      >
        {loading ? "ƒêang x·ª≠ l√Ω..." : "Thanh to√°n b·∫±ng Pi (Gi·∫£ l·∫≠p)"}
      </button>
    </main>
  );
}
