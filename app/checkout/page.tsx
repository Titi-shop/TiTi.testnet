"use client";
import { useEffect, useState } from "react";
import { useCart } from "../context/CartContext";
import { useRouter } from "next/navigation";
import { ArrowLeft } from "lucide-react";

declare global { interface Window { Pi?: any; } }

export default function CheckoutPage() {
  const { cart, clearCart, total } = useCart();
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [user, setUser] = useState<any>(null);
  const [shipping, setShipping] = useState<any>(null);

  useEffect(() => {
  try {
    const piUser = localStorage.getItem("pi_user");
    if (piUser) {
      const userData = JSON.parse(piUser);
      setUser(userData.username || "guest");
    } else {
      const username = localStorage.getItem("titi_username");
      if (username) setUser(username);
    }
  } catch {
    setUser("guest");
  }
}, []);

  useEffect(() => {
    const saved = localStorage.getItem("shipping_info");
    if (saved) setShipping(JSON.parse(saved));
  }, []);

  const handlePay = async () => {
    if (!user) {
      alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Pi Network tr∆∞·ªõc khi thanh to√°n!");
      router.push("/pilogin");
      return;
    }

    if (!window.Pi) {
      alert("‚ö†Ô∏è M·ªü trang trong Pi Browser ƒë·ªÉ thanh to√°n!");
      return;
    }

    if (!shipping) {
      alert("üì¶ Vui l√≤ng th√™m ƒë·ªãa ch·ªâ giao h√†ng!");
      router.push("/customer/address");
      return;
    }

    if (cart.length === 0) {
      alert("üõí Gi·ªè h√†ng tr·ªëng!");
      return;
    }

    setLoading(true);

    try {
      // üßπ Hu·ª∑ pending payment n·∫øu c√≥
      try {
        const pending = await window.Pi.getCurrentPayments();
        if (pending && pending.length > 0) {
          const last = pending[0];
          await fetch("/api/pi/cancel", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId: last.identifier }),
          });
          alert("ƒê√£ hu·ª∑ giao d·ªãch c≈©, s·∫µn s√†ng thanh to√°n m·ªõi.");
        }
      } catch {}

      window.Pi.init({ version: "2.0", sandbox: false });
      const scopes = ["payments", "username", "wallet_address"];
      const auth = await window.Pi.authenticate(scopes, (res: any) => res);

      const orderId = Date.now();
      const paymentData = {
        amount: total,
        memo: `Thanh to√°n ƒë∆°n h√†ng #${orderId}`,
        metadata: {
          orderId,
          buyer: user.username,
          uid: user.uid,
          items: cart,
        },
      };

      const callbacks = {
        onReadyForServerApproval: async (paymentId: string) => {
          await fetch("/api/pi/approve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId }),
          });
        },
        onReadyForServerCompletion: async (paymentId: string, txid: string) => {
          const res = await fetch("/api/pi/complete", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ paymentId, txid }),
          });
          const data = await res.json();

          if (res.ok && (data?.success || true)) {
            const order = {
              id: orderId,
              buyer: user.username,
              items: cart,
              total,
              status: "ƒê√£ thanh to√°n",
              shipping,
              note: `Pi TXID: ${txid}`,
            };
            await fetch("/api/orders", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(order),
            });
            clearCart();
            alert("‚úÖ Thanh to√°n th√†nh c√¥ng!");
            router.push("/customer/pending");
          } else {
            alert("‚ö†Ô∏è Giao d·ªãch ƒëang ch·ªù x√°c minh.");
          }
        },
        onCancel: () => alert("‚ùå B·∫°n ƒë√£ hu·ª∑ giao d·ªãch."),
        onError: (err: any) => alert("üí• L·ªói: " + err.message),
      };

      await window.Pi.createPayment(paymentData, callbacks);
    } catch (err: any) {
      alert("‚ùå L·ªói thanh to√°n: " + err.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <main className="max-w-md mx-auto min-h-screen bg-gray-50 flex flex-col justify-between">
      <div className="flex items-center justify-between bg-white p-3 border-b sticky top-0 z-10">
        <button onClick={() => router.back()} className="flex items-center text-gray-700 hover:text-blue-600">
          <ArrowLeft className="w-5 h-5 mr-1" /> <span>Back</span>
        </button>
        <h1 className="font-semibold text-gray-800">Thanh to√°n</h1>
        <div className="w-5" />
      </div>
      {/* ... Gi·ªØ nguy√™n ph·∫ßn UI hi·ªÉn th·ªã s·∫£n ph·∫©m & t·ªïng ti·ªÅn */}
      <div className="fixed bottom-16 left-0 right-0 bg-white border-t p-4 flex justify-between items-center max-w-md mx-auto">
        <div>
          <p className="text-gray-600 text-sm">T·ªïng c·ªông:</p>
          <p className="text-xl font-bold text-orange-600">{total.toFixed(2)} Pi</p>
        </div>
        <button
          onClick={handlePay}
          disabled={loading}
          className={`px-6 py-3 rounded-lg font-semibold text-white text-sm ${
            loading ? "bg-gray-400" : "bg-orange-600 hover:bg-orange-700"
          }`}
        >
          {loading ? "ƒêang x·ª≠ l√Ω..." : "Pay Now"}
        </button>
      </div>
    </main>
  );
}
