"use client";

import { useState, useEffect } from "react";
import Image from "next/image";
import { useRouter } from "next/navigation";
import { useLanguage } from "../../context/LanguageContext";

interface Product {
  id: number;
  name: string;
  price: number;
  description?: string;
  images?: string[];
}

export default function SellerStockPage() {
  const { translate } = useLanguage();
  const router = useRouter();
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState("");
  const [refreshing, setRefreshing] = useState(false);

  // üßæ L·∫•y danh s√°ch s·∫£n ph·∫©m
  const fetchProducts = async () => {
    try {
      const res = await fetch("/api/products", { cache: "no-store" });
      if (!res.ok) throw new Error("Fetch failed");
      const data = await res.json();
      setProducts(Array.isArray(data) ? data : []);
    } catch (err) {
      console.error("‚ùå L·ªói t·∫£i s·∫£n ph·∫©m:", err);
      setMessage(translate("load_error") || "Kh√¥ng th·ªÉ t·∫£i s·∫£n ph·∫©m.");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchProducts();
  }, []);

  // ‚ùå Xo√° s·∫£n ph·∫©m
  const handleDelete = async (id: number) => {
    const confirmDelete = window.confirm(
      translate("confirm_delete") || "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?"
    );
    if (!confirmDelete) return;

    try {
      setRefreshing(true);
      const res = await fetch(`/api/products?id=${id}`, { method: "DELETE" });
      const result = await res.json();

      if (result.success) {
        setMessage(translate("delete_success") || "ƒê√£ x√≥a s·∫£n ph·∫©m.");
        await fetchProducts();
      } else {
        setMessage(result.message || "Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m.");
      }
    } catch (err) {
      console.error("‚ùå DELETE Error:", err);
      setMessage(translate("delete_error") || "L·ªói khi x√≥a s·∫£n ph·∫©m.");
    } finally {
      setRefreshing(false);
    }
  };

  return (
    <main className="p-4 max-w-3xl mx-auto">
      <h1 className="text-2xl font-bold text-center mb-4">
        üì¶ {translate("stock_manager_title") || "Qu·∫£n l√Ω kho h√†ng"}
      </h1>

      {message && (
        <p
          className={`text-center mb-3 font-medium ${
            message.includes("x√≥a") || message.includes("L·ªói")
              ? "text-red-600"
              : "text-green-600"
          }`}
        >
          {message}
        </p>
      )}

      {loading ? (
        <p className="text-center text-gray-500">
          {translate("loading_products") || "ƒêang t·∫£i s·∫£n ph·∫©m..."}
        </p>
      ) : products.length === 0 ? (
        <p className="text-center text-gray-500">
          {translate("no_products") || "Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o."}
        </p>
      ) : (
        <div className="grid gap-4">
          {products.map((product) => {
            const img = product.images?.[0] || "";

            return (
              <div
                key={product.id}
                className="bg-white shadow-md rounded-lg p-4 border border-gray-200"
              >
                {img ? (
                  <Image
                    src={img}
                    alt={product.name}
                    width={400}
                    height={300}
                    className="w-full h-48 object-cover rounded-md mb-3"
                  />
                ) : (
                  <div className="w-full h-48 bg-gray-100 flex items-center justify-center text-gray-400 rounded-md mb-3">
                    {translate("no_image") || "Kh√¥ng c√≥ ·∫£nh"}
                  </div>
                )}

                <h2 className="text-lg font-semibold text-gray-800">{product.name}</h2>
                <p className="text-orange-600 font-bold mt-1">
                  üí∞ {product.price} Pi
                </p>
                {product.description && (
                  <p className="text-gray-500 mt-1">{product.description}</p>
                )}

                <div className="flex gap-2 mt-4">
                  <button
                    onClick={() => router.push(`/seller/edit/${product.id}`)}
                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-md font-medium transition"
                  >
                    ‚úèÔ∏è {translate("edit") || "S·ª≠a"}
                  </button>

                  <button
                    onClick={() => handleDelete(product.id)}
                    disabled={refreshing}
                    className="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-md font-medium transition"
                  >
                    {refreshing ? "‚è≥ ƒêang x√≥a..." : "‚ùå " + (translate("delete") || "X√≥a")}
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </main>
  );
}
