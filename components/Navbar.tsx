"use client";

import Link from "next/link";
import { useEffect, useState } from "react";
import { useLanguage } from "../app/context/LanguageContext";
import { ShoppingCart, Globe } from "lucide-react";
import { useRouter } from "next/navigation";

// ‚úÖ D·ªãch v·ª• l·∫•y gi√° Pi
class PiPriceService {
  static async getPiPrice() {
    try {
      // Option 1: GCV Fixed Price (·ªïn ƒë·ªãnh)
      const gcvPrice = 314159; // $314,159 USD / 1 Pi

      // Option 2 (t√πy ch·ªçn): L·∫•y t·ª´ API ngo√†i n·∫øu mu·ªën realtime
      // const response = await fetch('https://api.pi-price.com/current');
      // const data = await response.json();
      // return data.price;

      return gcvPrice;
    } catch (error) {
      console.error("Error fetching Pi price:", error);
      return 314159; // fallback GCV
    }
  }

  static formatPrice(price, currency = "USD") {
    return new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: currency,
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(price);
  }

  static formatPriceVND(priceUSD) {
    const usdToVnd = 23000; // t·ª∑ gi√° USD ‚Üí VND
    const priceVND = priceUSD * usdToVnd;
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(priceVND);
  }
}

export default function Navbar() {
  const { translate } = useLanguage();
  const [piPrice, setPiPrice] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [isSeller, setIsSeller] = useState(false);
  const router = useRouter();

  // üìà L·∫•y gi√° Pi (·ªïn ƒë·ªãnh b·∫±ng PiPriceService)
  useEffect(() => {
    const fetchPrice = async () => {
      try {
        const price = await PiPriceService.getPiPrice();
        setPiPrice(price);
      } catch (err) {
        console.error("L·ªói khi l·∫•y gi√° Pi:", err);
      } finally {
        setLoading(false);
      }
    };

    fetchPrice();
  }, []);

  // üë§ Ki·ªÉm tra t√†i kho·∫£n ƒëƒÉng nh·∫≠p ƒë·ªÉ hi·ªÉn th·ªã n√∫t "ƒêƒÉng h√†ng"
  useEffect(() => {
    try {
      const savedUser = localStorage.getItem("pi_user");
      if (savedUser) {
        const parsed = JSON.parse(savedUser);
        const username = parsed?.user?.username;
        if (username === "nguyenminhduc1991111") {
          setIsSeller(true);
        }
      }
    } catch (err) {
      console.error("L·ªói ƒë·ªçc pi_user:", err);
    }
  }, []);

  return (
    <header className="fixed top-0 left-0 right-0 bg-white border-b shadow-sm z-50">
      <div className="max-w-5xl mx-auto flex items-center justify-between px-4 py-2">
        <div className="flex items-center gap-3">
          {/* üõí Gi·ªè h√†ng */}
          <Link href="/cart" className="text-gray-700 hover:text-yellow-500">
            <ShoppingCart size={24} />
          </Link>

          {/* üü° N√∫t ƒêƒÉng h√†ng (ch·ªâ hi·ªán khi l√† seller) */}
          {isSeller && (
            <button
              onClick={() => router.push("/seller")}
              className="bg-yellow-400 hover:bg-yellow-500 text-black font-semibold px-3 py-1 rounded-lg text-sm"
            >
              üõí ƒêƒÉng h√†ng
            </button>
          )}
        </div>

        {/* üí∞ Gi√° Pi */}
        <div className="text-center">
          <p className="text-sm text-gray-500">
            {translate("pi_price") ?? "Pi Network"}
          </p>
          <p className="text-lg font-semibold text-yellow-600">
            {loading
              ? "ƒêang c·∫≠p nh·∫≠t..."
              : piPrice
              ? PiPriceService.formatPrice(piPrice, "USD")
              : "N/A"}
          </p>
        </div>

        {/* üåê Ng√¥n ng·ªØ */}
        <Link href="/language" className="text-gray-700 hover:text-yellow-500">
          <Globe size={24} />
        </Link>
      </div>
    </header>
  );
}
